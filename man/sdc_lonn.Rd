% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sdc_lonn.R
\name{sdc_lonn}
\alias{sdc_lonn}
\title{Undertrykking i lønnsstatistikk}
\usage{
sdc_lonn(
  data,
  between = NULL,
  within = NULL,
  var_vektet = c(manedslonn = "lonn_ekv_ialt_pub", avtalt = "lonn_ekv_fmlonn_pub", bonus
    = "lonn_ekv_bonus_pub", uregtil = "lonn_ekv_uregtil_pub", overtid =
    "lonn_overtid_pub"),
  var_uvektet = NULL,
  privat = "privat",
  var_med_privat = NULL,
  var_frtk_id = "frtk_id_ssb",
  var_virk_id = "virk_id_ssb",
  var_ekv_vekt = "lonn_ekv_vekt",
  var_dominans = var_vektet[1],
  var_sum = NULL,
  freq_within = 2,
  between_regel = TRUE,
  k1,
  k2,
  secondary2 = TRUE,
  grenseverdi = 100,
  grenseverdi2 = 4,
  extend0 = TRUE,
  removeEmpty = FALSE,
  formula = NULL,
  output = NULL,
  suppressed_data = NULL,
  dim_var_extra = NULL,
  avoidHierarchical = FALSE,
  structuralEmpty = FALSE,
  run_gauss = TRUE,
  roundBase = 0,
  roundMultiple = 1,
  verbose = TRUE
)
}
\arguments{
\item{data}{input data eller resultat fra \code{output = "aggregated"}}

\item{between}{Variabler som grupperer foretak eller en formel for disse.
Se også parameteren \code{formula} som er et alternativ.}

\item{within}{Variabler innen foretak eller en formel for disse.}

\item{var_vektet}{Lønnsvariabler navngitt ved navn som skal brukes i output. Ved manglende navn brukes variabelnavnet direkte.}

\item{var_uvektet}{Som \code{var_vektet} over, men disse variablene beregnes uvektet.
Default (\code{NULL}) er at ingen slike variabler er med.}

\item{privat}{Privatkoden som brukes. Default er \code{"privat"}.}

\item{var_med_privat}{Variabel (sektor) med privatkoden.
Default (\code{NULL}) betyr at det letes automatisk gjennom tabellvariabler (between) for å finne privat-koden.}

\item{var_frtk_id}{Variabelnavn for id for foretak. Default er \code{"frtk_id_ssb"}.}

\item{var_virk_id}{Variabelnavn for id for virksomhet.Default er \code{"virk_id_ssb"}.}

\item{var_ekv_vekt}{Variabelnavn for vekt for heltidsekvivalenter. Default er \verb{"lonn_ekv_vekt",}.}

\item{var_dominans}{Variabelnavn for variabel som er utganspunkt for dominansberegning.
Default er første \code{var_vektet}-variabel.
Dominansberegningen vekter uansett denne variabelen.}

\item{var_sum}{Ekstra numeriske variabler Som bare skal summeres,
navngitt ved navn som skal brukes i output.
Tilsvarende som \code{var_vektet} over.}

\item{freq_within}{max-verdi for primærprikking av Antall arbeidsforhold "within".
Se tekst (n_within) i  \code{\link{sdc_lonn_extra_details}}.}

\item{between_regel}{Ved TRUE er "between" utgangspunkt for dominansregler}

\item{k1}{Parameter i dominansprikking. Gjelder for dominansprikkingen der man ser på dominansen av ett foretak.
F.eks. betyr verdien \code{k1 = 80} her at hvis ett foretak, der \code{krav_ikke_offentlig = 0},
står for mer enn 80\% av alle arbeidsforholdene og/eller mer enn 80\% av summen av lønn
når det fordeles etter \code{between}-variabelene, så slår dominansprikkingen ut.}

\item{k2}{Parameter i dominansprikking. Gjelder for dominansprikkingen der man ser på dominansen av  to foretak.
F.eks. betyr verdien \code{k2 = 90} her at hvis to foretak,  der \code{krav_ikke_offentlig = 0},
står for mer enn 90\% av alle arbeidsforholdene og/eller mer enn 90\% av summen av lønn
når det fordeles etter \code{between}-variabelene, så slår dominansprikkingen ut.}

\item{secondary2}{\strong{Når \code{secondary2} er \code{TRUE}} sekundærprikkes det i to omganger.
\itemize{
\item I første omgang sekundærprikkes det ikke med tanke
på å hindre tilbakeregning  av between-totaler av Antall arbeidsforhold
ut fra dominansregler (\code{k1} og \code{k2}), men kun med tanke på within (f.eks. kjønn).
\item I andre omgang sekundærprikkes det også med tanke between-totaler som beskrevet over.
Det er antall heltidsekvivalenter som blir sekundærprikket ut fra dette.
}

Poenget med to runder er publisering av gjennomsnittsverdier og antall heltidsekvivalenter som må beskyttes av dominansregler.
Gjennomsnittsverdier kan tilbakeregnes  via summer (gjennomsnitt * antall heltidsekvivalenter)
dersom både gjennomsnitt og antall heltidsekvivalenter er tilgjengelig.
Dette hindres altså av sekundærprikkingen av antall heltidsekvivalenter.

\strong{Når \code{secondary2} er \code{FALSE}} fortas sekundærprikking bare en gang uten tanke på at antall
arbeidsforhold for between-totaler ikke må beskyttes.}

\item{grenseverdi}{Minste antall ok arbeidsforhold for publisering av
median, kvartiler og gjennomsnittslønn,
samt andre variabler som antall arbeidsforhold og antall heltidsekvivalenter.
(ingen sekundærprikking).
Se \code{\link{sdc_lonn_extra_details}}.}

\item{grenseverdi2}{Minste antall ok arbeidsforhold som ikke primærprikkes (\code{primary2}) forut for andre runde sekundærprikking.
Se \code{\link{sdc_lonn_extra_details}}.}

\item{extend0}{Ved noe annet enn \code{extend0 = TRUE}  kjøres \code{Extend0} i SSBtools. Trengs for beskyttelse av "within"-0-ere.
\itemize{
\item \strong{\code{extend0 = TRUE}} (default): Innen hver between-gruppen så sjekkes det om alle kombinasjoner av within-variablene som fra før
finnes i dataene også fins i den bestemte between-gruppen. Hvis ikke legges det til observasjoner med 0.
\code{FALSE} og også \code{TRUE} kan gi warning som kan slås av med parameteren \code{structuralEmpty} (se nedenfor).
\item \strong{\code{extend0 = "full"}}: I motsetning til \code{TRUE} så legges det også til kombinasjoner som ikke fins i dataene fra før.
Ved \code{avoidHierarchical = FALSE} (default) respekteres hierarkiske sammenhenger slik at ikke
"umulige" kombinasjoner legges til. Ved \code{avoidHierarchical = TRUE} legges det til alle mulige kombinasjoner.
\item \strong{\code{extend0} som liste}: Avansert spesifisering av hvordan within-variablene kombineres.
Eks: \code{extend0 <- list("A", "B", c("C", "D"))}.
Det legges til alle mulige kombinasjoner av \code{A}, \code{B} og \verb{(C}-\code{D}-kombinasjoner som fins i dataene fra før\verb{)}.
}}

\item{removeEmpty}{Ved TRUE fjernes between-kombinasjoner der det ikke finnes data. Dette er en parameter til ModelMatrix i SSBtools.}

\item{formula}{En formel som inkluderer både between- og within-variablene.
Parameteren \code{within} brukes da i tillegg, mens \code{between}-parameteren ikke er i bruk (ignoreres).}

\item{output}{Mulighet for annen output.}

\item{suppressed_data}{Outputdata fra en annen kjøring av \code{sdc_lonn}. Prikkingen skal samordnes slik at
kombinasjoner som fins i \code{suppressed_data} prikkes på samme måte.
Det blir nye variabler i output, \code{krav_inputsupp} og \code{krav_inputsupp2}.
Disse forteller om prikking som er samordnet. Verdiene ved samordning
er 0 (ikke prikket) eller 1 (prikket) og ellers missing.
Overlapp mellom prikkingene i de to rundene er ikke fjernet.
For at dette skal virke må man passe på at like variabler får samme navn.
Se \code{dim_var_extra} nedenfor.
Ved bruk av \code{list} kan flere datasett være input. F.eks.:
\code{suppressed_data = list(out6, out7, out8)}}

\item{dim_var_extra}{Ekstra dimensjonsvariabler (som i \code{between}, \code{within}, \code{formula}) som skal tas hensyn til ved
navngiving av outputvariabler. Dette for å sikre like navn ved bruk av \code{suppressed_data}.
Det er ok med variabler som ikke får betydning (fins fra før i \code{between}, \code{within}, \code{formula}
eller ikke relatert til disse).}

\item{avoidHierarchical}{Ved TRUE og ved formelinput kombineres ikke hierarkiske variabler i output.
Dette er en parameter til ModelMatrix i SSBtools.
Om dette brukes blir \code{dim_var_extra} ignorert siden dette da ikke gir mening.
Se også parameteren \code{extend0}.}

\item{structuralEmpty}{When \code{TRUE}, output cells with no contributing inner cells (only zeros in column of \code{x})
are forced to be not primary suppressed.
Thus, these cells are considered as structural zeros.
When \code{structuralEmpty} is \code{TRUE}, the following error message is avoided:
\code{Suppressed} \code{cells} \code{with} \code{empty} \code{input} \code{will} \code{not} \code{be} \code{protected.}
\code{Extend} \code{input} \code{data} \code{with} \verb{zeros?}.
When \code{removeEmpty} is \code{TRUE}, \code{structuralEmpty} is superfluous.
Parameteren og beskrivelsen er kopiert fra \code{GaussSuppression::GaussSuppressionFromData}.
Bruk av \code{suppressed_data} kan føre til at celler allikevel blir primærprikket.}

\item{run_gauss}{Ingen sekundærprikking dersom denne settes til \code{FALSE}, Default er \code{TRUE}.}

\item{roundBase}{Ved andre verdier enn 0 foretas avrunding av antall arbeidsforhold.
Funksjonen  \code{\link{PLSroundingPublish}} bruker da denne \code{roundBase}-parameteren.
Ny ekstra variabel helt til slutt i output er \code{rounded_antall_arbeidsforhold}.
Variabelen \code{prikket_antall_arbeidsforhold} blir endret til å inneholde de samme avrundede verdiene,
bortsett fra at noen av dem er prikket.
Denne prikkingen endres også slik at dette kun handler om dominansregel.
Teknisk har da \code{n_within_krav} blitt flyttet til andre runde prikking (fra  \code{primary} til \code{primary2}).
Det sørges også for ingen primærprikking i første runde ved
\code{rounded_antall_arbeidsforhold} \code{<=} \code{roundBase}.
Litt modifisert blir også \code{krav_grenseverdi} ved at det også kreves
\code{rounded_antall_arbeidsforhold} \code{<} \code{grenseverdi}
i tillegg til at, som vanlig, \code{regel_within_okantall} \code{<} \code{grenseverdi}.}

\item{roundMultiple}{Når dette heltalltallet er større enn 1, vil avrunding også sørge for at
alle tall < \code{roundBase} \code{*} \code{roundMultiple} er \code{roundBase}-multipler.
F.eks. ved \code{roundBase}=3 og \code{roundMultiple}=2 så vil 1,2,4 og 5
ikke forekomme i avrundet output, mens 0, 3 og 6 forekommer.
Det sørges også for ingen primærprikking i første runde ved
\code{rounded_antall_arbeidsforhold} \code{<=} \code{roundBase} \code{*} \code{roundMultiple}.}

\item{verbose}{Whether to print information during calculations.}
}
\value{
data frame eller liste
}
\description{
Input er mikrodata og output er (samordnede) tabell(er) med alle ønskede aggregeringsnivåer.
}
\details{
Grunnen til at primary2 og secondary2 ikke nødvendigvis summeres til suppressed2 er
at det i primary2 kan inngå celler som er med i suppressed. Disse er fjernet fra suppressed2.\tabular{rl}{
   \strong{Når regel_within_ er starten på} \tab \strong{variabelnavnet} \cr
   \code{n_unique} \tab Antall unike foretak \cr
   \code{n_privat} \tab Antall unike private foretak \cr
   \code{n_offentlig} \tab Antall unike private offentlige foretak \cr
   \code{max_n} \tab Antall arbeidsforhold til foretaket med flest. \cr
    \tab Dette foretaket er \code{max_frtk_n}. \cr
   \code{second_max_n} \tab Antall arbeidsforhold til foretaket med nest flest. \cr
    \tab Dette foretaket er \code{second_max_frtk_n}. \cr
   \code{max_privat_n} \tab Antall arbeidsforhold til foretaket med flest blant de private. \cr
    \tab Dette foretaket er \code{max_frtk_privat_n}. \cr
   \code{second_max_privat_n} \tab Antall arbeidsforhold til foretaket med nest flest blant de private. \cr
    \tab Dette foretaket er \code{second_max_frtk_privat_n}. \cr
   \code{max_frtk_n} \tab Se over \cr
   \code{second_max_frtk_n} \tab Se over \cr
   \code{max_frtk_privat_n} \tab Se over \cr
   \code{second_max_frtk_privat_n} \tab Se over \cr
   \code{max_is_privat_n} \tab Hvorvidt \code{max_frtk_n} er et privat foretak. \cr
   \code{second_max_is_privat_n} \tab Hvorvidt \code{second_max_frtk_n} er et privat foretak. \cr
   \code{sum_n} \tab Totalt antall arbeidsforhold. \cr
   \code{priv_n} \tab Antall arbeidsforhold hos private foretak. \cr
   \code{max_l} \tab Sum lonn til foretaket med hoyest sum. Dette foretaket er \code{max_frtk_l}. \cr
   \code{second_max_l} \tab osv. ... \cr
   \code{max_privat_l} \tab ... \cr
   \code{second_max_privat_l} \tab ... \cr
   \code{max_frtk_l} \tab ... \cr
   \code{second_max_frtk_l} \tab ... \cr
   \code{max_frtk_privat_l} \tab ... \cr
   \code{second_max_frtk_privat_l} \tab ... \cr
   \code{max_is_privat_l} \tab ... \cr
   \code{second_max_is_privat_l} \tab ... \cr
   \code{sum_l} \tab Sum lonn total \cr
   \code{priv_l} \tab Sum lonn hos private foretak. \cr
   \code{n_arbeidsforhold} \tab Totalt antall arbeidsforhold.  (\verb{= sum_n}, men beregnet separat fra dominansrutinen) \cr
   \code{okantall} \tab Nøyaktig samme variabel som \verb{"okantall_arbeidsforhold".} \cr
}


\strong{Variablene som starter med  regel_}  er avledet fra \code{regel_within}_-variablene på følgende måte:
\itemize{
\item \code{regel_within_} ser på hver kombinasjon av within-variabler (som kjønn og alder).
I \code{regel_} er det bare totalverdiene for within-variablene som gjelder.
F.eks. antall heltidsekvivalenter er da ikke for spesifikk kombinasjon av kjønn og alder men total-verdi for between-variablene man ser på.
F.eks  en kombinasjon av arb_yrke_styrk08 og sektor3. I \code{regel_within_} er dermed mange rader like.
\item Nye variabler er lagt til
\itemize{
\item \code{regel_istot}: Denne er 1 nå det er en snakk om en rad der det er totaler for within-variablene.
For disse radene er \code{regel_}-variablene og \code{regel_within_}-variablene like.
\item \code{regel_dominant1_n}: Beregnet fra \code{regel_}-variablene som \code{max_n/sum_n}.
\item \code{regel_dominant2_n}: Beregnet fra \code{regel_}-variablene som \code{(max_n + second_max_n)/sum_n}.
\item \code{regel_dominant1_l}: Beregnet fra \code{regel_}-variablene som \code{max_l/sum_l}.
\item \code{regel_dominant2_l}: Beregnet fra \code{regel_}-variablene som \code{(max_l + second_max_l)/sum_l}.
}
}\tabular{rl}{
   \strong{krav_ i starten på} \tab \strong{variabelnavnet} forteller om spesifikke regler for prikking er oppfylt \cr
   \code{ikke_offentlig} \tab = \code{max_is_privat} OR (\code{n_offentlig == 1} AND \code{n_privat == 1}) \cr
   \code{dominant1_n} \tab = \code{regel_dominant1_n > k1} AND \code{ikke_offentlig} der \code{k1} er parameter i dominansregel \cr
   \code{dominant2_n} \tab = \code{regel_dominant2_n > k2} AND \code{ikke_offentlig} der \code{k2} er parameter i dominansregel \cr
   \code{dominant1_l} \tab = \code{regel_dominant1_l > k1} AND \code{ikke_offentlig} der \code{k1} er parameter i dominansregel \cr
   \code{dominant2_l} \tab = \code{regel_dominant2_l > k2} AND \code{ikke_offentlig} der \code{k2} er parameter i dominansregel \cr
   \code{dominant} \tab = \code{dominant1_n} OR \code{dominant2_n} OR \code{dominant1_l} OR \code{dominant2_l} \cr
   \code{n_within} \tab = \code{!regel_istot} AND \code{regel_within_n_arbeidsforhold <= freq_within} \cr
    \tab Dette er krav til primærprikking av Antall arbeidsforhold "within" basert på frekvensregel. \cr
    \tab \code{freq_within} er input-parameter, 2 er default. \cr
   \code{istot} \tab = \code{regel_istot} \cr
   \code{grenseverdi} \tab = \code{regel_within_okantall < grenseverdi}   (altså krav_grenseverdi = ...) \cr
    \tab \code{grenseverdi} er input-parameter, 100 er default. (altså ikke krav_grenseverdi) \cr
   \code{grenseverdi2} \tab = \code{regel_within$n_arbeidsforhold > 0 & regel_within_okantall < grenseverdi2} \cr
   \code{primary} \tab = (\code{!istot} AND \code{dominant}) OR \code{n_within.} \cr
    \tab Dette er primærprikking til grunn for føreste runde med sekundærprikking. \cr
   \code{primary2} \tab = (\code{istot} AND \code{dominant})  OR  \code{grenseverdi2_krav} \cr
    \tab Dette er primærprikking til grunn for andre runde med sekundærprikking. \cr
   \code{secondary} \tab Resultat fra første runde med sekundærprikking. \cr
   \code{secondary2} \tab Resultat fra andre runde med sekundærprikking. \cr
   \code{suppressed} \tab All prikking i første runde. \cr
   \code{suppressed2} \tab All prikking fra andre runde bortsett fra at mulig overlapp med suppressed er fjernet. \cr
   \code{lonn} \tab = \code{grenseverdi} OR \code{dominant} \cr
   \code{arbeidsforhold} \tab = \code{suppressed} OR \code{lonn} \cr
   \code{ekvivalent} \tab = \code{suppressed} OR \code{suppressed2} OR \code{lonn} \cr
}

\itemize{
\item Disse krav-variablene er egentlig logiske (TRUE/FALSE), men i output blir dette 0/1.
\item \code{krav_arbeidsforhold} og \code{krav_ekvivalent} samsvarer nøyaktig med endelig prikking av tilsvarende variabler.
\item \code{krav_lonn} samsvarer med endelig prikking av lønnsvariablene (median, snitt og kvartiler).
\item Her er det skrevet OR og AND istedenfor vanlige r-kode operatorer som er \code{|} og \code{&}.
(Det var ikke mulig med tegnet  \code{|} i tabellen over p.g.a kombinasjon markdown/roxygen/latex.)
\item Operatoren \code{!} betyr "ikke".
}
}
\examples{

# Siden default er fjernet i ny versjon 
between <- c("yrke1", "yrke2", "yrke3", "arb_yrke_styrk08", "sektor3")
within <- c("pers_kjoenn", "arb_heldeltid")

a <- sdclonn_data("syntetisk_5000")
out <- sdc_lonn(a, between = between, within = within, k1 = 85, k2 = 95)
out2 <- sdc_lonn(a, between = ~yrke3 + (yrke2 + yrke1) * sektor3,  
                 within = ~arb_heldeltid, k1 = 85, k2 = 95)

# Med avrunding. Altså bruk av roundBase-parameteren
outR <- sdc_lonn(a, between = between, within = within, roundBase = 3,
                 k1 = 85, k2 = 95)

out2A <- sdc_lonn(a, between = ~yrke3 + (yrke2 + yrke1) * sektor3, within = ~arb_heldeltid, 
                  output = "aggregated")
out2B <- sdc_lonn(out2A, k1 = 85, k2 = 95)
identical(out2, out2B)
out2C <- sdc_lonn(out2A, k1 = 80, k2 = 90)
identical(out2, out2C)

out3 <- sdc_lonn(a, grenseverdi = 20, between = between, within = within,
                 var_uvektet = c(stillingspst = "arb_stillingspst", alder = "pers_alder"),
                 k1 = 80, k2 = 90)

out4 <- sdc_lonn(a, between = 
  ~(yrke3 + (yrke2 + yrke1) * sektor3) + pers_kommnr * (yrke2 + yrke1) + arb_fylke * yrke1, 
  within = ~arb_heldeltid * pers_kjoenn, output = "aggregated")
  
out4A <- sdc_lonn(out4, k1 = 90, k2 = 95)
out4B <- sdc_lonn(out4, k1 = 80, k2 = 90)
out4C <- sdc_lonn(out4, k1 = 90, k2 = 95, grenseverdi = 20)

### Skriver ut antall prikker eller antall der krav-variabel er TRUE.
sum2(out)
sum2(out3)
sum2(out4A)
sum2(out4B)
sum2(out4C)
sum2(out2)
sum2(out2C)


####  Bruk av formula_selection + long_sdclonn  ####

s2a <- formula_selection(out2, ~yrke1 * sektor3 * arb_heldeltid)
s2b <- formula_selection(out2, ~yrke3 * arb_heldeltid)
s2a_long <- long_sdclonn(s2a)
s2b_long <- long_sdclonn(s2b)


####  Bruk av formula + formula_selection + long_sdclonn  ####

out5 <- sdc_lonn(a, formula = ~arb_fylke * (yrke1 + yrke2) * arb_heldeltid * pers_kjoenn 
                     + (arb_fylke + pers_kommnr) * yrke1 * pers_kjoenn, 
                 within = c("pers_kjoenn", "arb_heldeltid"),
                 var_med_privat = "sektor3", 
                 k1 = 80, k2 = 90)

s5a <- formula_selection(out5, ~arb_fylke * (yrke1 + yrke2) * arb_heldeltid * pers_kjoenn)
s5b <- formula_selection(out5, ~(arb_fylke + pers_kommnr) * yrke1 * pers_kjoenn)
s5a_long <- long_sdclonn(s5a)
s5b_long <- long_sdclonn(s5b)


####  Bruk av suppressed_data.   #### 
#   out7 og out8 er som out5, uten alt samtidig 

out6 <- sdc_lonn(a, formula = ~arb_fylke * yrke1 * arb_heldeltid * pers_kjoenn 
                     + arb_fylke * yrke1 * pers_kjoenn, # Overflødig linje, men skader ikke 
                 within = c("pers_kjoenn", "arb_heldeltid"), 
                 var_med_privat = "sektor3", 
                 k1 = 80, k2 = 90,
                 dim_var_extra = c("yrke2", "pers_kommnr"),)

out7 <- sdc_lonn(a, formula = ~arb_fylke * (yrke1 + yrke2) * arb_heldeltid * pers_kjoenn, 
                 within = c("pers_kjoenn", "arb_heldeltid"), 
                 var_med_privat = "sektor3", 
                 dim_var_extra = c("yrke2", "pers_kommnr"),
                 k1 = 80, k2 = 90, 
                 suppressed_data = out6)

out8 <- sdc_lonn(a, formula = ~(arb_fylke + pers_kommnr) * yrke1 * pers_kjoenn, 
                 within = "pers_kjoenn", 
                 var_med_privat = "sektor3", 
                 dim_var_extra = c("yrke2", "pers_kommnr"),
                 k1 = 80, k2 = 90, 
                 suppressed_data = out6)
     
# out5 på nytt med tre datasett som suppressed_data                   
out5b <- sdc_lonn(a, formula = ~arb_fylke * (yrke1 + yrke2) * arb_heldeltid * pers_kjoenn 
                     + (arb_fylke + pers_kommnr) * yrke1 * pers_kjoenn, 
                 within = c("pers_kjoenn", "arb_heldeltid"),
                 var_med_privat = "sektor3",
                 k1 = 80, k2 = 90,
                 suppressed_data = list(out6, out7, out8))                
                 

}
\seealso{
Se ekstra detaljer: \code{\link{sdc_lonn_extra_details}}.
}
